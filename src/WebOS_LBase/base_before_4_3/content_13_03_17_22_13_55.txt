Chinaunix首页　| 　论坛　| 　博客 登录 | 注册
    
gjf05_05的ChinaUnix博客
暂无签名
IT精英在米国创办的农场
CU博客频道3月技术图书有奖试读征文活动
2013中国数据库技术大会火热报名中
首页　| 　博文目录　| 　关于我

gjf05_05
博客访问： 7434
博文数量： 46
博客积分： 264
博客等级： 二等列兵
用 户 组： 普通用户
注册时间： 2012-05-25 08:46

文章分类
全部博文（46）

原创（8）
未分配的博文（38）
文章存档
2012年（46）

我的朋友

聆音听墨

hui_unix

Bean_lee

_Rayx

baocq
最近访客

Bean_lee
订阅
推荐博文
·nagios 监控log文件
·jsp页面调用火狐插件
·【原创】cacti搭建遇到的那些...
·LINUX下软RAID 5实现
·InnoDB 数据表压缩原理与限制...
热词专题
·二维数组作为实参
·myprint 语言
·realquery query 区别
·xp怎样提升用户权限
·st16c554 驱动
友情链接
 USB协议基本知识 2012-07-22 17:24:08
分类：
原文地址：USB协议基本知识 作者：三点水兽
USB协议基本知识 
USB 基本知识
USB的重要关键概念:
1、    端点，位于USB设备或主机上的一个数据缓冲区，用来存放和发送USB的各种数据，每一个端点都有惟一的确定地址，有不同的传输特性（如输入端点、输出端点、配置端点、批量传输端点）
2、    帧，时间概念，在USB中，一帧就是1MS，它是一个独立的单元，包含了一系列总线动作，USB将1帧分为好几份，每一份中是一个USB的传输动作。
3、上行、下行：设备到主机为上行，主机到设备为下行

一条USB的传输线分别由地线、电源线、D+、D-四条线构成，D+和D-是差分输入线，它使用的是3.3V的电压（注意哦，与CMOS的5V电平不同），而电源线和地线可向设备提供5V电压，最大电流为500MA（可以在编程中设置的，至于硬件的实现机制，就不要管它了）。

数据在USB线里传送是由低位到高位发送的。

USB数据是由二进制数字串构成的，首先数字串构成域（有七种），域再构成包，包再构成事务（IN、OUT、SETUP），事务最后构成传输（中断传输、并行传输、批量传输和控制传输）。下面简单介绍一下域、包、事务、传输，请注意他们之间的关系。

一、    域是USB数据最小的单位，由若干位组成（至于是多少位由具体的域决定），域可分为七个类型：
1、    同步域（SYNC），八位，值固定为0000 0001，用于本地时钟与输入同步
2、    标识域（PID），由四位标识符+四位标识符反码构成，表明包的类型和格式。
3、    地址域（ADDR）：七位地址，代表了设备在主机上的地址，地址000 0000被命名为零地址，是任何一个设备第一次连接到主机时，在被主机配置、枚举前的默认地址。
4、    端点域（ENDP），四位，由此可知一个USB设备有的端点数量最大为16个。
5、    帧号域（FRAM），11位，每一个帧都有一个特定的帧号，帧号域最大容量0x800。
6、    数据域（DATA）：长度为0~1023字节，在不同的传输类型中，数据域的长度各不相同，但必须为整数个字节的长度
7、    校验域（CRC）：对令牌包和数据包中非PID域进行校验的一种方法。

二、    包由域构成，有四种类型，分别是令牌包、数据包、握手包和特殊包，前面三种是重要的包，不同的包的域结构不同，介绍如下
包，可分为输入包、输出包、设置包和帧起始包（注意这里的输入包是用于设置输入命令的，输出包是用来设置输出命令的，而不是放据数的），其中输入包、输出包和设置包的格式都是一样的：SYNC+PID+ADDR+ENDP+CRC5（五位的校验码）   
1、    帧起始包的格式：
    SYNC+PID+11位FRAM+CRC5（五位的校验码）
2、    数据包：分为DATA0包和DATA1包，当USB发送数据的时候，当一次发送的数据长度大于相应端点的容量时，就需要把数据包分为好几个包，分批发送，DATA0包和DATA1包交替发送，即如果第一个数据包是DATA0，那第二个数据包就是DATA1。但也有例外情况，在同步传输中（四类传输类型中之一），所有的数据包都是为DATA0，格式如下：
SYNC+PID+0~1023字节+CRC16
    
3、    握手包：结构最为简单的包，格式如下
    SYNC+PID

三、    事务分为IN事务、OUT事务和SETUP事务三大事务，每一种事务都由令牌包、数据包、握手包构成，每个包的发送有一定的时间先后顺序，因此事务分为三个阶段：
1、    令牌包阶段：启动一个输入、输出或设置的事务
2、    数据包阶段：按输入、输出发送相应的数据
3、    握手包阶段：返回数据接收情况，在同步传输的IN和OUT事务中没有这个阶段，这是比较特殊的。

1、 IN事务：
令牌包阶段：主机发送一个PID为IN的输入包给设备，通知设备要往主机发送数据。
数据包阶段：设备根据情况会作出三种应答（要注意：数据包阶段也不总是传送数据的，
根据传输情况还会提前进入握手包阶段）
A、    设备端点正常，设备往入主机里面发出数据包（DATA0与DATA1交替）。
B、    设备正在忙，无法往主机发出数据包就发送NAK无效包，IN事务提前结束。
C、    相应设备端点被禁止，发送错误包STALL包，事务也就提前结束了，总线进入空闲状态。
握手包阶段：主机正确接收到数据之后就会向设备发送ACK包。
2、 OUT事务：
令牌包阶段：主机发送一个PID为OUT的输出包给设备，通知设备要接收数据；
数据包阶段：比较简单，就是主机会设备送数据，DATA0与DATA1交替
握手包阶段：设备根据情况会作出三种反应
    A、    设备端点接收正确，设备往入主机返回ACK，通知主机可以发送新的数据，如果数据包
发生了CRC校验错误，将不返回任何握手信息；
B、    设备正在忙，无法往主机发出数据包就发送NAK无效包，通知主机再次发送数据；
C、    相应设备端点被禁止，发送错误包STALL包，事务提前结束，总线直接进入空闲状态。
3、    SETUT事务：
    A、    令牌包阶段：主机发送一个PID为SETUP的输出包给设备，通知设备要接收数据；
B、    数据包阶段：比较简单，就是主机会设备送数据，注意，这里只有一个固定为8个字节的DATA0包，这8个字节的内容就是标准的USB设备请求命令，共有11条。
C、    握手包阶段：设备接收到主机的命令信息后，返回ACK，此后总线进入空闲状态，并准备下一个传输（在SETUP事务后通常是一个IN或OUT事务构成的传输）。

四、传输：传输由OUT、IN、SETUP事务其中的事务构成，传输有四种类型：中断传输、批量传输、同步传输、控制传输，中断传输和批量转输的结构一样，同步传输有最简单的结构，而控制传输是最重要的也是最复杂的传输。
1、    中断传输：由OUT事务和IN事务构成，用于键盘、鼠标等HID设备的数据传输中
2、    批量传输：由OUT事务和IN事务构成，用于大容量数据传输，没有固定的传输速率，也不占用带宽，当总线忙时，USB会优先进行其他类型的数据传输，而暂时停止批量转输。
3、    同步传输：由OUT事务和IN事务构成，有两个特殊地方，第一，在同步传输的IN和OUT事务中是没有返回包阶段的；第二，在数据包阶段所有的数据包都为DATA0
4、    控制传输：最重要的也是最复杂的传输，控制传输由三个阶段构成（初始设置阶段、可选数据阶段、状态信息步骤），每一个阶段可以看成一个的传输，
控制传输其实是由三个传输构成的，用来于USB设备初次加接到主机之后，主机通过控制传输来交换信息，设备地址和读取设备的描述符，使得主机识别设备，并安装相应的驱动程序，这是每一个USB开发者都要关心的问题。

1、    初始设置：就是一个由SET事务构成的传输
2、    可选数据：就是一个由IN或OUT事务构成的传输，这个步骤是可选的，要看初始设置步骤有没有要求读/写数据（由SET事务的数据包阶段发送的标准请求命令决定）
3、状态信息：获取状态信息，由IN或OUT事务构成的传输，但是要注意这里的IN和OUT事务和之前的INT和OUT事务有两点不同：
A、传输方向相反，通常IN表示设备往主机送数据，OUT表示主机往设备送数据；在这里，IN表示主机往设备送数据，而OUT表示设备往主机送数据。
B、在这个里，数据包阶段的数据包都是0长度的，即SYNC+PID+CRC16
    
总结：USB的最小单元是“域”，由“域”构成了“包”，在由“包”构成了“事务”，最后由“事务”构成了“传输”，在应用层面，我们看到的只是传输，所以USB协议栈就需要完成传输以下的所有事情。这对标准的USB协议栈提出了最基本的要求。
阅读(161) | 评论(0) | 转发(0) |
0
上一篇：Git学习教程（一）：git简介
下一篇：关于AIX 系统空间的监控
相关热门文章
mechanize自动登录程序
太原1路usb电话录音盒80元1556...
天津1路usb电话录音盒80元1556...
大连1路usb电话录音盒80元1556...
哈尔滨1路usb电话录音盒80元15...
承接自动化测试培训、外包、实...
Solaris PowerTOP 1.0 发布
For STKMonitor
项目小体会
phpStudy 2010下载，PHP5开发...
欢迎QuickLock在ChinaUnix博客...
3. DB2 Control Center
高性能服务器设计
parsley学习指南7-动态视图注...
RAID 技术经典解析
给主人留下些什么吧！~~
评论热议
请登录后评论。
登录 注册
关于我们 | 关于IT168 | 联系方式 | 广告合作 | 法律声明 | 免费注册
Copyright 2001-2010 ChinaUnix.net All Rights Reserved 北京皓辰网域网络信息技术有限公司. 版权所有
感谢所有关心和支持过ChinaUnix的朋友们
京ICP证041476号 京ICP证060528号
